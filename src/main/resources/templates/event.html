<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<div th:replace="~{fragments/head :: head}"></div>
<body>
	<div th:replace="~{fragments/nav :: nav}"></div>
	<div th:replace="~{fragments/alertMessages :: alertMessages}"></div>

	<div class="container my-4 p-2" style="max-width: 90%;">
		<!-- Back Button (เหนือสุดของทั้ง 2 section) -->
		<div class="my-4">
			<button class="btn btn-link text-dark text-decoration-none p-0"
				onclick="history.back()">
				<i class="bi bi-arrow-left me-2 fs-5"></i> <span>Back</span>
			</button>
		</div>

		<!-- Organizer Actions Dropdown -->
		<div th:if="${status.isCreator}" class="dropdown my-2 ms-auto">
			<button class="btn btn-outline-secondary rounded-4" type="button"
			data-bs-toggle="dropdown">
				<i class="bi bi-gear"></i> Manage Event
			</button>
			<ul class="dropdown-menu p-2 me-2">
				<li><a class="dropdown-item text-secondary"
					th:href="@{/events/{id}/edit(id=${event.id})}"> <i
						class="bi bi-pencil"></i> Edit Event
				</a></li>
				<li><a class="dropdown-item text-secondary"
					th:href="@{/events/{id}/members(id=${event.id})}"> <i
						class="bi bi-people"></i> View Members
				</a></li>
				<!-- 
				<li><hr class="dropdown-divider"></li>
				<li>
					<form th:action="@{/events/{id}/delete(id=${event.id})}"
						method="post"
						onsubmit="return confirm('Are you sure you want to delete this event? This action cannot be undone.')">
						<button type="submit" class="dropdown-item text-danger">
							<i class="bi bi-trash"></i> Delete Event
						</button>
					</form>
				</li>
				 -->
			</ul>
		</div>
		<!-- Section 1: Event -->
		<div
			class="bg-white border border-light-subtle rounded-4 shadow-sm mb-4 p-4">
			<!-- Event Image -->
			<div th:if="${event.imagePath}" class="mb-4">
				<img th:src="@{'/' + ${event.imagePath}}" th:alt="${event.title}"
					class="img-fluid rounded-3-top w-100"
					style="object-fit: cover; max-height: 400px;">
			</div>


			<!-- Event Title -->
			<h1 class="text-dark mb-3" th:text="${event.title}"></h1>

			<!-- Category Button -->
			<div class="d-flex mb-3">
				<a th:href="@{/categories(selected=${event.category.id})}"
					class="card categ-card text-decoration-none">

					<button
						class="btn rounded-4 text-center p-2 mx-2"
						th:text="${event.category.name}">
						<i th:class="${event.category.iconClass}"></i>
					</button>
				</a>
			</div>

			<!-- Event Details (3 columns) -->
			<div class="row g-3 mb-4">
				<!-- Date -->
				<div class="col-md-4">
					<div class="d-flex align-items-center">
						<i class="bi bi-calendar4-event text-muted me-2 px-2 fs-5"></i>
						<div>
							<small class="text-muted d-block">Date</small> <span
								th:text="${#temporals.format(event.date, 'EEEE dd MMMM, yyyy ''at'' HH:mm')}"></span>
						</div>
					</div>
				</div>

				<!-- Location -->
				<div class="col-md-4">
					<div class="d-flex align-items-center">
						<i class="bi bi-geo-alt text-muted me-2 px-2 fs-5"></i>
						<div>
							<small class="text-muted d-block">Location</small> <span
								th:text="${event.location}"></span>
						</div>
					</div>
				</div>

				<!-- Participants -->
				<div class="col-md-4">
					<div class="d-flex align-items-center">
						<i class="bi bi-people text-muted me-2 px-2 fs-5"></i>
						<div class="w-100">
							<small class="text-muted d-block mb-2">Participants</small>
							<div class="progress mb-1 me-4" style="height: 6px;">
								<div class="progress-bar"
									th:style="'width: ' + ${(event.currentParticipants * 100) / event.maxParticipants} + '%; background-color: #6f42c1;'">
								</div>
							</div>
						</div>
					</div>	
				</div>
			</div>

			<!-- Join / Leave / Full / Organizer & Bookmark -->
			<div class="d-flex flex-wrap gap-2 mb-4">
				<!-- End -->
				<div th:if="${status.isPastEvent}">
					<span class="btn rounded-4 p-2 btn-outline-secondary disabled"
					style="width: 200px;">
						<i class="bi bi-dash-circle-dotted me-1"></i> Event Ended
					</span>
				</div>
				<div th:unless="${status.isPastEvent}">
					<!-- Join Event -->
					<div>
						<form
							th:if="${!status.isCreator and !event.full and status.canJoin}"
							th:action="@{/events/{id}/join(id=${event.id})}" method="post"
							class="d-inline">
							<button type="submit"
								class="btn text-white rounded-4 p-2"
								style="background-color: #6f42c1; width: 200px;">
								<i class="bi bi-person-plus me-1"></i> Join Event
							</button>
						</form>
					</div>
					<div>
						<!-- Leave Event -->
						<form th:if="${status.isMember and !status.isCreator}"
							th:action="@{/events/{id}/leave(id=${event.id})}" method="post"
							class="flex-grow-1">
							<button type="submit"
								class="btn rounded-4 p-2 btn-outline-danger"
								style="width: 200px;">
								<i class="bi bi-person-dash me-1"></i> Leave Event
							</button>
						</form>
					</div>
					<!-- Event Full -->
					<span th:if="${event.full and !status.isMember}"
						class="btn rounded-4 p-2 btn-outline-secondary disabled"
						style="width: 200px;">
						<i class="bi bi-exclamation-circle me-1"></i> Event Full
					</span>
					<!-- Organizer -->
					<span th:if="${status.isCreator}"
						class="btn rounded-4 p-2 disabled"
						style="background-color: transparent; border: 1px solid #6f42c1; color: #6f42c1; width: 200px;"> 
						<i class="bi bi-star me-1"></i> You're the Organizer
					</span>
				</div>

				<!-- Bookmark -->
				<div>
					<form th:if="${!status.isBookmarked}"
						th:action="@{/events/{id}/bookmark(id=${event.id})}" method="post"
						class="d-inline">
						<button type="submit"
							class="btn btn-outline-warning btn-sm">
							<i class="bi bi-bookmark fs-5"></i>
						</button>
					</form>
					<form th:if="${status.isBookmarked}"
						th:action="@{/events/{id}/unbookmark(id=${event.id})}"
						method="post" class="d-inline">
						<button type="submit"
							class="btn btn-warning btn-sm">
							<i class="bi bi-bookmark-fill fs-5 text-white"></i>
						</button>
					</form>
				</div>
			</div>
			<!-- About Event -->
			<h4 class="text-dark mb-2">About this event</h4>
			<div style="white-space: pre-line; word-wrap: break-word;">
				<p class="text-muted lh-lg mb-4" th:text="${event.description}">
				</p>
			</div>

			<!-- Organizers -->
			<h5 class="text-dark mb-3">Organized by</h5>
			<div class="d-flex align-items-center">
				<i class="bi bi-person"
					style="width: 50px; height: 50px; object-fit: cover;"></i>
				<div>
					<div th:text="${event.creator.username}"></div>
					<small class="text-muted" th:text="${event.creator.email}"></small>
				</div>
			</div>
		</div>

		<!-- Section 2: Comments -->
		<div
			class="bg-white border border-light-subtle rounded-4 shadow-sm mb-5 p-4">
			<!-- Comments Header -->
			<h4 class="text-dark mb-4">
				<i class="bi bi-chat-dots me-2" style="color: #6f42c1;"></i>Comments
			</h4>

			<!-- Comment Input -->
			<div class="mb-4" th:unless="${status.isPastEvent}">
				<form th:action="@{/events/{id}/comments(id=${event.id})}"
					th:object="${commentDto}" method="post">
					<div class="mb-3">
						<textarea class="form-control border-light-subtle rounded-3 mb-2"
							th:field="*{text}" rows="3" placeholder="Add a comment..."></textarea>
					</div>
					<div th:if="${#fields.hasErrors('text')}" class="text-danger small">
						<span th:errors="*{text}"></span>
					</div>
					<input type="hidden" th:field="*{eventId}" th:value="${event.id}" />

					<button type="submit" class="btn text-white rounded-4 p-2"
						style="background-color: #6f42c1;">
						<div class="mx-2"><i class="bi bi-send me-2"></i> Post Comment</div>
					</button>

				</form>

			</div>

			<!-- Previous Comments -->
			<div class="border-top pt-4">

				<div th:if="${#lists.isEmpty(comments)}"
					class="text-muted text-center">
					<p>No comments yet. Be the first to comment!</p>
				</div>
			</div>
			<div class="border-top pt-4">
				<div th:each="comment : ${comments}" class="mb-3">
					<div class="d-flex">
						<div class="flex-shrink-0">
							<i class="bi bi-person-circle text-muted"
								style="font-size: 2rem;"></i>
						</div>
						<div class="flex-grow-1 ms-3">
							<div class="d-flex justify-content-between align-items-start">
								<div>
									<h6 class="mb-1" th:text="${comment.user.username}"></h6>
									<small class="text-muted"
										th:text="${#temporals.format(comment.createdAt, 'MMM dd, yyyy HH:mm')}"></small>
								</div>
								<!-- Delete button for comment owner -->
								<div
									th:if="${currentUser != null and !comment.deleted and comment.user.id == currentUser.id}">
									<form
										th:action="@{/events/{eventId}/comments/{commentId}/delete(eventId=${event.id}, commentId=${comment.id})}"
										method="post" style="display: inline;"
										onsubmit="return confirm('Are you sure you want to delete this comment?')">
										<button type="submit" class="btn btn-outline-danger btn-sm">
											<i class="bi bi-trash"></i>
										</button>
									</form>
								</div>
							</div>
							<p class="mb-1 mt-2" th:text="${comment.text}"
								th:classappend="${comment.deleted} ? 'text-muted fst-italic' : ''"></p>
						</div>

					</div>
					<hr th:unless="${commentStat.last}">
				</div>
			</div>


		</div>
	</div>
	
	<style>
		.categ-card {
			border: none;
			border-radius: 15px;
		}

		.categ-card:hover {
			transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s
				ease;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			background-color: #F0E9FF;
			color: #921ffa;
		}
	</style>

	<div th:replace="~{fragments/footer :: footer}"></div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>