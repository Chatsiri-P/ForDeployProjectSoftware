<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<div th:replace="~{fragments/head :: head}"></div>
<body>
	<div th:replace="~{fragments/nav :: nav}"></div>

	<section class="container my-4 p-2">

		<div class="container p-2 mb-2">
			<h1 class="text">Categories</h1>
			<p class="text">Find your community and share passions with new
				friends</p>
		</div>

		<section class="container my-4">
			<div
				class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">

				<div class="col" th:each="category : ${categories}">
					<div class="card categ-card h-100 position-relative"
						th:classappend="${selectedCategoryId == category.id ? 'active' : ''}"
						onclick="selectCategory(this.dataset.categoryId)"
						th:attr="data-category-id=${category.id}">
						<div class="card-body text-center">
							<i th:class="${category.iconClass}"
								style="font-size: 3rem;"></i>
							<h5 class="card-title" th:text="${category.name}"></h5>
							<p class="card-text" th:text="${category.description}"></p>
							<small class="text-muted"> <span
								th:text="${#lists.size(category.events)}"></span> events
							</small>
						</div>
						<!-- <a class="stretched-link" th:href="@{/category(view='study')}"></a> -->
					</div>
				</div>


			</div>

			<!-- Selected Category Events -->
			<div th:if="${selectedCategory}" class="mt-5">
				<div class="row align-items-center mb-4">
					<div class="col">
						<h3 class="mb-0">
							<i th:class="${selectedCategory.iconClass}"></i> <span
								th:text="${selectedCategory.name}"></span> Events
						</h3>
						<p class="text-muted mb-0"
							th:text="${selectedCategory.description}"></p>
					</div>
					<div class="col-auto">
						<button class="btn btn-outline-secondary rounded-4"
							onclick="clearSelection()">
							<i class="bi bi-x"></i> Clear Selection
						</button>
					</div>
				</div>

				<div th:if="${#lists.isEmpty(categoryEvents)}">
					<div
						th:replace="fragments/no-content :: noContent(
				        'bi-calendar-x', 
				        'No events in this category yet',
				        'Be the first to create an event in this category!',
						'/events/create',
				        'Create Event')">
					</div>
				</div>

				<div class="row">
					<div th:each="event : ${categoryEvents}"
						class="col-md-6 col-lg-4 mb-4">
						<div class="card h-100 event-card">
							<!-- Event Image -->
							<div th:if="${event.imagePath}" class="card-img-top-container">
								<img th:src="@{'/' + ${event.imagePath}}" class="card-img-top"
									style="height: 200px; object-fit: cover;"
									th:alt="${event.title}">
							</div>
							<div th:unless="${event.imagePath}"
								class="bg-light d-flex align-items-center justify-content-center"
								style="height: 200px;">
								<i class="bi bi-calendar-event text-muted"
									style="font-size: 3rem;"></i>
							</div>

							<div class="card-body d-flex flex-column">
								<h5 class="card-title" th:text="${event.title}"></h5>
								<p class="card-text"
									th:text="${#strings.abbreviate(event.description, 100)}"></p>

								<div class="mb-2">
									<small class="text-muted event-meta">
										<i th:class="${event.category.iconClass}"></i> <span
										th:text="${event.category.name}"></span>
									</small>
								</div>
								
								<div class="mb-2">
									<small class="text-muted event-meta"> <i
										class="bi bi-calendar"></i> <span
										th:text="${#temporals.format(event.date, 'MMM dd, yyyy HH:mm')}"></span>
									</small>
								</div>

								<div class="mb-2">
									<small class="text-muted event-meta"> <i
										class="bi bi-geo-alt"></i> <span th:text="${event.location}"></span>
									</small>
								</div>

								<div class="mb-2">
									<small class="text-muted event-meta"> <i
										class="bi bi-person"></i> by <span
										th:text="${event.creator.username}"></span>
									</small>
								</div>

								<div class="mb-3">
									<small class="text-muted event-meta"> <i
										class="bi bi-people"></i> <span
										th:text="${event.currentParticipants} + '/' + ${event.maxParticipants}"></span>
										participants
									</small>
									<div class="progress mt-1" style="height: 4px;">
										<div class="progress-bar"
										th:style="'width: ' + ${(event.currentParticipants * 100) / event.maxParticipants} + '%; background-color: #6f42c1;'">
										</div>
									</div>
								</div>

								
								<div class="d-flex gap-2">
									<a th:href="@{/events/{id}(id=${event.id})}"
										class="btn text-white rounded-4 p-2 mt-3 w-75" 
										style="background-color: #6f42c1;"> 
										<i class="bi bi-eye me-1"></i> View Details
									</a>

									<div sec:authorize="isAuthenticated()" class="d-flex flex-column w-25"
										role="group">
										<!-- Join Button -->
										<form
											th:if="${currentUser != null and event.creator.id != currentUser.id and !event.full and canJoin[event.id]}"
											th:action="@{/events/{id}/join(id=${event.id})}"
											method="post" class="d-inline">
											<button type="submit" 
											class="btn text-white rounded-4 p-2 mt-3 w-100" 
											style="background-color: #6f42c1;">
												<i class="bi bi-person-plus"></i> Join
											</button>
										</form>
										<span th:if="${event.full}"
										class="btn rounded-4 p-2 mt-3 w-100 btn-outline-secondary disabled"> 
											<i class="bi bi-exclamation-circle"></i> Full
										</span>
									</div>
								</div>
								
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<style>
.categ-card {
	border: none;
	border-radius: 15px;
}

.categ-card:hover {
	transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s
		ease;
	box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
	background-color: #F0E9FF;
	color: #921ffa;
}

.categ-card.active {
	box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
	color: #921ffa;
}
</style>
		<script>
			function selectCategory(categoryId) {
				window.location.href = '/categories?selected=' + categoryId;
			}

			function clearSelection() {
				window.location.href = '/categories';
			}
		</script>
	</section>

	<!-- <div th:replace="~{fragments/show :: show(${showTitle})}"></div> -->

	<div th:replace="~{fragments/footer :: footer}"></div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>